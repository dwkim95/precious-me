<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIND DIVE</title>
    <meta name="description" content="당신의 마음 깊은 곳에 숨겨진 진짜 모습을 찾아서">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600&family=Noto+Serif+KR:wght@300;400&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #0a0f1b;
            color: #e8ecf1;
            line-height: 1.65;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* 배경 효과 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        /* 물방울 애니메이션 */
        .water-drop {
            position: fixed;
            width: 4px;
            height: 4px;
            background: rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            pointer-events: none;
            z-index: 2;
            animation: dropFall linear infinite;
        }

        @keyframes dropFall {
            0% {
                transform: translateY(-100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: scale(1);
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
        }

        /* 별똥별 애니메이션 */
        .shooting-star {
            position: fixed;
            width: 2px;
            height: 2px;
            background: rgba(168, 85, 247, 0.8);
            border-radius: 50%;
            pointer-events: none;
            z-index: 2;
            animation: shootingStar linear infinite;
            box-shadow: 0 0 6px rgba(168, 85, 247, 0.5);
        }

        @keyframes shootingStar {
            0% {
                transform: translateX(-100px) translateY(-100px) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: scale(1);
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(100vw) translateY(100vh) scale(0);
                opacity: 0;
            }
        }

        /* 기본 애니메이션 */
        @keyframes wave {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(100px); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
            50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.5); }
        }

        @keyframes slideInFromBottom {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            z-index: 3;
        }

        /* 화면 전환 효과 */
        .screen {
            animation: fadeIn 0.6s ease;
        }

        .screen.fade-out {
            animation: fadeOut 0.4s ease forwards;
        }

        /* 오디오 컨트롤 */
        .audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .audio-control:hover {
            background: rgba(30, 41, 59, 0.9);
            transform: scale(1.1);
        }

        .audio-control.playing {
            animation: pulseGlow 2s infinite;
        }

        /* 로고 */
        .logo {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo h1 {
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, #60a5fa 0%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .logo p {
            font-size: 0.95rem;
            color: #94a3b8;
            font-weight: 300;
            line-height: 1.4;
        }

        .intro-text {
            font-family: 'Noto Serif KR', serif;
            font-size: 1.05rem;
            line-height: 1.8;
            color: #cbd5e1;
            text-align: center;
            margin-bottom: 48px;
            font-weight: 300;
            word-break: keep-all;
        }

        .intro-text em {
            font-style: normal;
            color: #e8ecf1;
            font-weight: 400;
        }

        .btn-primary {
            width: 100%;
            padding: 18px 32px;
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            line-height: 1.4;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* 스토리 화면 */
        .story-container {
            text-align: center;
            padding: 40px 0;
            animation: slideInFromBottom 0.6s ease;
        }

        .story-title {
            font-family: 'Noto Serif KR', serif;
            font-size: 1.3rem;
            font-weight: 400;
            color: #a5b4fc;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .story-text {
            font-family: 'Noto Serif KR', serif;
            font-size: 1rem;
            line-height: 1.8;
            color: #cbd5e1;
            margin-bottom: 40px;
            font-weight: 300;
            word-break: keep-all;
        }

        .story-text em {
            font-style: normal;
            color: #e8ecf1;
            font-weight: 400;
        }

        /* 진행 상태 */
        .progress-section {
            margin-bottom: 40px;
            animation: slideInFromBottom 0.5s ease;
        }

        .depth-indicator {
            font-size: 0.85rem;
            color: #64748b;
            text-align: center;
            margin-bottom: 16px;
            font-weight: 400;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            line-height: 1.4;
        }

        .progress-bar {
            height: 3px;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #6366f1 100%);
            border-radius: 3px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3));
            animation: shimmer 2s infinite;
        }

        /* 질문 카드 */
        .question-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 32px 28px;
            margin-bottom: 32px;
            animation: slideInFromBottom 0.6s ease;
        }

        .question-text {
            font-family: 'Noto Serif KR', serif;
            font-size: 1.25rem;
            line-height: 1.7;
            color: #f1f5f9;
            text-align: center;
            font-weight: 400;
            word-break: keep-all;
        }

        /* 선택지 */
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-btn {
            background: rgba(30, 41, 59, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 12px;
            padding: 20px 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            color: #e2e8f0;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            overflow: hidden;
            opacity: 0;
            animation: slideInFromBottom 0.4s ease forwards;
            word-break: keep-all;
        }

        .option-btn:nth-child(1) { animation-delay: 0.1s; }
        .option-btn:nth-child(2) { animation-delay: 0.2s; }
        .option-btn:nth-child(3) { animation-delay: 0.3s; }
        .option-btn:nth-child(4) { animation-delay: 0.4s; }

        .option-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.5s;
        }

        .option-btn:hover::before {
            left: 100%;
        }

        .option-btn:hover {
            background: rgba(30, 41, 59, 0.5);
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateX(4px);
        }

        .option-btn.selected {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.5);
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* 로딩 화면 */
        .loading-container {
            text-align: center;
            padding: 60px 0;
            animation: fadeInScale 0.6s ease;
        }

        .wave-loader {
            display: inline-flex;
            gap: 8px;
            margin-bottom: 32px;
        }

        .wave-dot {
            width: 8px;
            height: 8px;
            background: #60a5fa;
            border-radius: 50%;
            animation: wave 1.4s ease-in-out infinite;
        }

        .wave-dot:nth-child(2) { animation-delay: 0.2s; }
        .wave-dot:nth-child(3) { animation-delay: 0.4s; }
        .wave-dot:nth-child(4) { animation-delay: 0.6s; }
        .wave-dot:nth-child(5) { animation-delay: 0.8s; }

        .loading-message {
            font-family: 'Noto Serif KR', serif;
            font-size: 1rem;
            line-height: 1.8;
            color: #94a3b8;
            font-weight: 300;
            word-break: keep-all;
        }

        /* 결과 화면 */
        .result-header {
            text-align: center;
            margin-bottom: 48px;
            animation: fadeInScale 0.6s ease;
        }

        .result-badge {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 20px;
            font-size: 0.8rem;
            color: #a5b4fc;
            margin-bottom: 16px;
            font-weight: 500;
            letter-spacing: 0.05em;
            line-height: 1.4;
        }

        .result-title {
            font-family: 'Noto Serif KR', serif;
            font-size: 2rem;
            font-weight: 400;
            line-height: 1.3;
            color: #f8fafc;
            margin-bottom: 12px;
        }

        .result-subtitle {
            font-size: 1rem;
            color: #94a3b8;
            font-weight: 300;
            line-height: 1.6;
            word-break: keep-all;
        }

        .result-section {
            background: rgba(30, 41, 59, 0.3);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 20px;
            opacity: 0;
            animation: slideInFromBottom 0.6s ease forwards;
        }

        .result-section:nth-child(2) { animation-delay: 0.1s; }
        .result-section:nth-child(3) { animation-delay: 0.2s; }
        .result-section:nth-child(4) { animation-delay: 0.3s; }

        .result-section h3 {
            font-size: 1.1rem;
            font-weight: 500;
            color: #e8ecf1;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            line-height: 1.4;
        }

        .result-section p {
            font-size: 0.95rem;
            line-height: 1.8;
            color: #cbd5e1;
            font-weight: 300;
            word-break: keep-all;
        }

        .letter-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%);
            border: 1px solid rgba(99, 102, 241, 0.15);
            position: relative;
            overflow: hidden;
        }

        .letter-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        .letter-content {
            font-family: 'Noto Serif KR', serif;
            font-size: 1rem;
            line-height: 1.9;
            color: #e8ecf1;
            position: relative;
            z-index: 1;
            word-break: keep-all;
        }

        .letter-content strong {
            color: #a5b4fc;
            font-weight: 400;
        }

        /* 공유 버튼 */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            animation: slideInFromBottom 0.6s ease 0.4s both;
        }

        .btn-secondary {
            flex: 1;
            padding: 14px 20px;
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            color: #e2e8f0;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            line-height: 1.4;
        }

        .btn-secondary:hover {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(148, 163, 184, 0.3);
        }

        .btn-kakao {
            background: #fee500;
            color: #3c1e1e;
            border-color: #fee500;
        }

        .btn-kakao:hover {
            background: #fdd835;
            border-color: #fdd835;
        }

        .btn-text {
            display: block;
            margin: 24px auto 0;
            background: none;
            border: none;
            color: #64748b;
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.3s;
            animation: fadeIn 0.6s ease 0.5s both;
            line-height: 1.4;
        }

        .btn-text:hover {
            color: #94a3b8;
        }

        /* 숨김 */
        .hidden {
            display: none !important;
        }

        /* 모바일 최적화 */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            .logo h1 {
                font-size: 2.2rem;
            }

            .question-text {
                font-size: 1.15rem;
                padding: 0 4px;
            }

            .result-title {
                font-size: 1.75rem;
            }

            .option-btn {
                padding: 18px 20px;
                font-size: 0.9rem;
            }

            .intro-text, 
            .story-text, 
            .loading-message {
                font-size: 0.95rem;
                padding: 0 4px;
            }

            .result-section p,
            .letter-content {
                font-size: 0.9rem;
                padding: 0 4px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-secondary {
                font-size: 0.9rem;
            }

            .audio-control {
                top: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>

<body>
    <!-- 오디오 컨트롤 -->
    <div class="audio-control" id="audioControl" title="배경음악">
        <span id="audioIcon">🔊</span>
    </div>

    <!-- 배경음악 -->
    <audio id="bgMusic" loop preload="auto">
        <!-- 실제 BGM 대신 Web Audio API로 생성한 심해 사운드 -->
    </audio>

    <div class="container">
        <!-- 시작 화면 -->
        <div class="screen" id="welcomeScreen">
            <div class="logo">
                <h1>MIND DIVE</h1>
                <p>마음의 심해로 떠나는 여행</p>
            </div>
            
            <div class="intro-text">
                지금 이 순간, 혼자가 아니에요.<br>
                수많은 사람들이 각자의 마음 깊은 곳에서<br>
                <em>진짜 자신</em>을 찾고 있습니다.<br><br>
                
                당신의 마음도 깊고 아름다운 바다와 같아요.<br>
                표면의 파도 아래에는<br>
                고요하고 따뜻한 세계가 기다리고 있습니다.<br><br>
                
                오늘은 당신을 위한 시간.<br>
                함께 천천히 내려가 보아요.
            </div>
            
            <button class="btn-primary" onclick="startJourney()">마음의 바다로 들어가기</button>
        </div>

        <!-- 스토리 화면 -->
        <div class="screen hidden" id="storyScreen">
            <div class="story-container">
                <h2 class="story-title" id="storyTitle"></h2>
                <div class="story-text" id="storyText"></div>
                <button class="btn-primary" onclick="continueJourney()">계속 나아가기</button>
            </div>
        </div>

        <!-- 질문 화면 -->
        <div class="screen hidden" id="questionScreen">
            <div class="progress-section">
                <div class="depth-indicator" id="depthIndicator">수심 0m</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div class="question-card">
                <div class="question-text" id="questionText"></div>
            </div>
            
            <div class="options" id="optionsContainer"></div>
        </div>

        <!-- 로딩 화면 -->
        <div class="screen hidden" id="loadingScreen">
            <div class="loading-container">
                <div class="wave-loader">
                    <div class="wave-dot"></div>
                    <div class="wave-dot"></div>
                    <div class="wave-dot"></div>
                    <div class="wave-dot"></div>
                    <div class="wave-dot"></div>
                </div>
                <div class="loading-message" id="loadingMessage">
                    바다 깊은 곳에서 소중한 것을 발견했습니다
                </div>
            </div>
        </div>

        <!-- 결과 화면 -->
        <div class="screen hidden" id="resultScreen">
            <div class="result-header">
                <div class="result-badge">DEEP SEA DISCOVERY</div>
                <h2 class="result-title" id="resultTitle"></h2>
                <p class="result-subtitle" id="resultSubtitle"></p>
            </div>

            <div class="result-section">
                <h3>당신이 세상에 주는 선물 ✨</h3>
                <p id="lightSide"></p>
            </div>

            <div class="result-section">
                <h3>때로는 힘든 당신의 마음 💙</h3>
                <p id="shadowSide"></p>
            </div>

            <div class="result-section letter-section">
                <div class="letter-content" id="letterContent"></div>
            </div>

            <div class="action-buttons">
                <button class="btn-secondary btn-kakao" onclick="shareKakao()">카카오톡</button>
                <button class="btn-secondary" onclick="shareResult()">공유하기</button>
                <button class="btn-secondary" onclick="copyLink()">링크복사</button>
            </div>

            <button class="btn-text" onclick="restartDive()">다시 잠수하기</button>
        </div>
    </div>

    <script>
        // 전역 상태 관리
        let gameState = {
            currentDepth: 0,
            currentStory: 0,
            responses: [],
            isTransitioning: false,
            scores: {
                pearl: 0,
                current: 0,
                abyss: 0,
                coral: 0,
                gentle: 0,
                brave: 0,
                wise: 0,
                free: 0
            }
        };

        // 오디오 관리 (단순화)
        let audioContext = null;
        let isMusicPlaying = false;
        let currentAudioNodes = null;

        // 심해 사운드 생성 (더 간단하고 확실한 방법)
        function createOceanSound() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // 화이트 노이즈 생성
                const bufferSize = audioContext.sampleRate * 2;
                const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
                
                const whiteNoise = audioContext.createBufferSource();
                whiteNoise.buffer = noiseBuffer;
                whiteNoise.loop = true;
                
                // 필터로 바다 소리 만들기
                const lowpass = audioContext.createBiquadFilter();
                lowpass.type = 'lowpass';
                lowpass.frequency.value = 300;
                lowpass.Q.value = 1;
                
                const highpass = audioContext.createBiquadFilter();
                highpass.type = 'highpass';
                highpass.frequency.value = 20;
                
                const gainNode = audioContext.createGain();
                gainNode.gain.value = 0.1;
                
                // 연결
                whiteNoise.connect(highpass);
                highpass.connect(lowpass);
                lowpass.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                whiteNoise.start();
                
                return { whiteNoise, gainNode };
            } catch (e) {
                console.log('오디오 생성 실패:', e);
                return null;
            }
        }

        // 오디오 초기화 (단순화)
        function initAudio() {
            const audioControl = document.getElementById('audioControl');
            const audioIcon = document.getElementById('audioIcon');
            
            audioControl.addEventListener('click', () => {
                if (!isMusicPlaying) {
                    currentAudioNodes = createOceanSound();
                    if (currentAudioNodes) {
                        isMusicPlaying = true;
                        audioIcon.textContent = '🔊';
                        audioControl.classList.add('playing');
                    }
                } else {
                    if (currentAudioNodes && currentAudioNodes.whiteNoise) {
                        currentAudioNodes.whiteNoise.stop();
                        currentAudioNodes = null;
                    }
                    isMusicPlaying = false;
                    audioIcon.textContent = '🔇';
                    audioControl.classList.remove('playing');
                }
            });
        }

        // 스토리 데이터
        const stories = [
            {
                title: "출발",
                text: "수면이 당신을 부드럽게 감싸줍니다.<br><br>처음엔 누구나 불안해해요. 괜찮아요.<br><em>천천히, 자연스럽게.</em><br><br>당신만의 속도로 가면 됩니다."
            },
            {
                title: "첫 번째 깊이",
                text: "햇살이 물속으로 스며들어<br>아름다운 빛줄기를 만들고 있어요.<br><br>여기서 잠시 쉬어가도 좋습니다.<br><em>서두르지 마세요.</em>"
            },
            {
                title: "조금 더 깊은 곳",
                text: "빛이 조금씩 부드러워지고 있네요.<br><br>이 고요함이 낯설어도 괜찮아요.<br>당신은 <em>충분히 안전</em>합니다."
            },
            {
                title: "중간 지점",
                text: "여기까지 온 당신이 대단해요.<br><br>주변이 조금 어두워졌지만<br>당신 안의 빛은 <em>더욱 밝아지고</em> 있어요."
            },
            {
                title: "더 깊은 마음으로",
                text: "정적이 당신을 감싸고 있습니다.<br><br>이 고요함 속에서<br>당신의 진실한 목소리에 <em>귀 기울여보세요.</em>"
            },
            {
                title: "마음의 바닥 근처",
                text: "거의 다 왔어요.<br><br>여기까지 용기 내어 내려온 당신,<br>정말 <em>용감한 사람</em>이에요."
            }
        ];

        // 질문 데이터
        const questions = [
            {
                depth: 10,
                text: "친구들과 함께 있을 때\n당신은 주로 어떤 모습인가요?",
                options: [
                    { text: "조용히 듣고 있다가 필요할 때 말해요", type: "gentle" },
                    { text: "재미있는 이야기나 새로운 제안을 해요", type: "brave" },
                    { text: "진지한 대화나 깊은 주제를 좋아해요", type: "wise" },
                    { text: "분위기에 따라 자연스럽게 바뀌어요", type: "free" }
                ]
            },
            {
                depth: 50,
                text: "스트레스가 쌓였을 때\n가장 먼저 하고 싶은 일은?",
                options: [
                    { text: "혼자만의 조용한 공간에서 쉬고 싶어요", type: "pearl" },
                    { text: "뭔가 활동적인 걸 하며 풀고 싶어요", type: "coral" },
                    { text: "왜 스트레스받는지 원인을 찾고 싶어요", type: "abyss" },
                    { text: "평소와 전혀 다른 걸 해보고 싶어요", type: "current" }
                ]
            },
            {
                depth: 120,
                text: "카페에서 혼자 앉아 있을 때\n주로 무엇을 하고 있나요?",
                options: [
                    { text: "창밖을 보며 조용히 생각에 잠겨있어요", type: "gentle" },
                    { text: "할 일 정리하거나 계획을 세우고 있어요", type: "brave" },
                    { text: "사람들을 관찰하며 이런저런 상상을 해요", type: "wise" },
                    { text: "그때그때 기분에 따라 달라져요", type: "free" }
                ]
            },
            {
                depth: 200,
                text: "좋아하는 사람이 힘들어할 때\n당신의 첫 반응은?",
                options: [
                    { text: "조용히 곁에 있어주며 위로해요", type: "pearl" },
                    { text: "해결방법을 함께 찾아보자고 해요", type: "coral" },
                    { text: "진심으로 그 마음을 이해하려고 해요", type: "abyss" },
                    { text: "그 순간 필요한 걸 자연스럽게 해줘요", type: "current" }
                ]
            },
            {
                depth: 300,
                text: "새로운 환경에 적응해야 할 때\n당신은 어떤 타입인가요?",
                options: [
                    { text: "천천히 익숙해질 때까지 기다려요", type: "gentle" },
                    { text: "적극적으로 배우고 적응하려고 해요", type: "brave" },
                    { text: "왜 이런 변화가 필요한지부터 생각해요", type: "wise" },
                    { text: "일단 경험해보며 자연스럽게 흘러가요", type: "free" }
                ]
            },
            {
                depth: 450,
                text: "밤늦게 잠들기 전\n마지막에 드는 생각은?",
                options: [
                    { text: "오늘 하루도 고생했다, 내일은 더 평온했으면", type: "pearl" },
                    { text: "내일은 뭘 해볼까, 어떻게 더 나아질까", type: "coral" },
                    { text: "오늘 있었던 일들의 의미를 되짚어봐요", type: "abyss" },
                    { text: "내일은 또 어떤 하루가 될까 궁금해요", type: "current" }
                ]
            },
            {
                depth: 600,
                text: "가장 소중한 사람과 헤어져야 한다면\n어떤 마음이 들까요?",
                options: [
                    { text: "조용히 받아들이지만 오래 그리워할 것 같아요", type: "gentle" },
                    { text: "슬프지만 서로의 성장을 위해 응원할게요", type: "brave" },
                    { text: "왜 헤어져야 하는지 깊이 생각해볼 것 같아요", type: "wise" },
                    { text: "슬프지만 새로운 만남도 기대할 것 같아요", type: "free" }
                ]
            },
            {
                depth: 750,
                text: "인생에서 가장 중요하다고 생각하는 것은?",
                options: [
                    { text: "마음의 평화와 안정감", type: "pearl" },
                    { text: "꾸준한 성장과 발전", type: "coral" },
                    { text: "진실한 관계와 깊은 이해", type: "abyss" },
                    { text: "자유로움과 새로운 경험", type: "current" }
                ]
            },
            {
                depth: 900,
                text: "10년 후의 나에게 하고 싶은 말은?",
                options: [
                    { text: "지금보다 더 평온하고 행복하길 바라", type: "gentle" },
                    { text: "꿈꿔왔던 모든 걸 이뤘으면 좋겠어", type: "brave" },
                    { text: "지금의 고민들이 어떤 의미였는지 알려줘", type: "wise" },
                    { text: "어떤 모습이든 그때의 너를 응원할게", type: "free" }
                ]
            },
            {
                depth: 1050,
                text: "지금 이 순간 가장 필요한 것은?",
                options: [
                    { text: "따뜻한 위로와 충분한 휴식", type: "pearl" },
                    { text: "새로운 동기와 도전할 용기", type: "coral" },
                    { text: "나 자신에 대한 깊은 이해", type: "abyss" },
                    { text: "마음 편히 흘러갈 수 있는 자유", type: "current" }
                ]
            },
            {
                depth: 1200,
                text: "마지막 질문입니다.\n당신이 가장 소중히 간직하고 싶은 것은?",
                options: [
                    { text: "지금까지 쌓아온 소중한 추억들", type: "gentle" },
                    { text: "더 나은 내일을 만들어갈 희망", type: "brave" },
                    { text: "진실된 마음과 깊은 감정들", type: "wise" },
                    { text: "언제나 변화할 수 있는 가능성", type: "free" }
                ]
            }
        ];

        // 확장된 결과 데이터 (12가지 조합)
        const results = {
            "pearl-gentle": {
                title: "평온한 진주",
                subtitle: "고요함 속에서 따뜻한 빛을 품은 영혼",
                light: "당신은 세상의 소음 속에서도 흔들리지 않는 중심을 가진 사람입니다. 차분하고 온화한 성격으로 주변 사람들에게 안정감을 주어요. 당신의 존재만으로도 누군가는 위로받고 있습니다.",
                shadow: "때로는 너무 많은 것을 혼자 감당하려 해서 지칠 때가 있어요. 자신의 감정을 표현하는 것을 어려워하기도 하죠. 당신도 충분히 보살핌받을 자격이 있다는 것을 기억해주세요.",
                letter: "고요한 바다 깊은 곳에서 오랜 시간 빛을 키워온 진주처럼, 당신은 정말 특별한 사람이에요. ✨<br><br>당신의 <strong>부드러운 힘</strong>이 이 세상을 더 따뜻하게 만들어주고 있어요. 급하지 않게, 천천히 자신만의 속도로 빛나는 당신이 아름다워요. 💙"
            },
            "pearl-brave": {
                title: "용기 있는 진주",
                subtitle: "평화로우면서도 강인한 의지를 가진 영혼",
                light: "당신은 평온함과 용기를 동시에 가진 균형잡힌 사람입니다. 어려운 상황에서도 침착함을 잃지 않으면서 필요할 때는 과감하게 행동할 줄 알아요. 이런 당신의 모습이 많은 사람들에게 신뢰감을 줍니다.",
                shadow: "완벽해 보이려는 압박감을 스스로에게 주기도 해요. 항상 강해야 한다고 생각해서 자신의 약한 모습을 숨기려 할 때가 있어요. 때로는 그냥 쉬어도 괜찮다는 것을 잊지 마세요.",
                letter: "고요한 힘과 용감한 마음을 함께 가진 당신은 정말 드문 존재예요. 🌟<br><br>평화를 사랑하면서도 <strong>필요할 때는 앞장서는 용기</strong>를 가진 당신이 멋져요. 당신만의 균형감각을 계속 믿어주세요. ✨"
            },
            "current-free": {
                title: "자유로운 해류",
                subtitle: "끊임없이 흐르며 새로운 길을 만드는 영혼",
                light: "당신은 변화를 두려워하지 않는 자유로운 영혼입니다. 새로운 것에 대한 호기심이 많고, 고정관념에 얽매이지 않는 유연한 사고를 가지고 있어요. 당신의 창의성과 적응력은 많은 사람들에게 영감을 줍니다.",
                shadow: "때로는 너무 많은 변화를 추구하다가 정작 중요한 것을 놓치기도 해요. 끊임없이 움직이다 보니 지칠 때도 있고, 한 곳에 정착하는 것을 어려워하기도 하죠.",
                letter: "끝없이 흘러가며 새로운 길을 만들어내는 해류처럼, 당신은 세상에 변화와 활력을 가져다주는 소중한 존재예요. 🌊<br><br>당신의 <strong>자유로운 정신</strong>이 많은 사람들에게 희망과 가능성을 보여주고 있어요. 그 흐름을 믿고 계속 나아가세요. ✨"
            },
            "abyss-wise": {
                title: "지혜로운 심연",
                subtitle: "깊은 통찰력으로 진실을 탐구하는 영혼",
                light: "당신은 표면적인 것에 만족하지 않고 늘 더 깊은 의미를 찾으려 하는 사람입니다. 복잡한 상황도 본질을 꿰뚫어보는 지혜가 있고, 다른 사람들이 놓치는 것들을 발견하는 능력이 있어요.",
                shadow: "깊이 생각하다 보니 때로는 무거운 감정에 압도될 때가 있어요. 모든 것을 진지하게 받아들여서 단순한 즐거움을 놓치기도 하죠. 가끔은 가벼운 마음으로 세상을 바라봐도 좋아요.",
                letter: "가장 깊은 곳까지 탐험할 용기를 가진 당신은 진정한 탐험가예요. 🔮<br><br>당신의 <strong>깊은 지혜</strong>가 혼란스러운 세상에 방향을 제시해주고 있어요. 그 깊이를 두려워하지 말고, 당신만이 발견할 수 있는 진실들을 계속 찾아가세요. 💙"
            },
            "coral-brave": {
                title: "역동적인 산호초",
                subtitle: "끊임없이 성장하며 생명력을 발산하는 영혼",
                light: "당신은 어떤 환경에서도 적응하며 성장하는 놀라운 생명력을 가진 사람입니다. 목표를 향해 꾸준히 나아가는 의지력과 동시에 주변 사람들을 격려하는 따뜻함을 가지고 있어요.",
                shadow: "너무 많은 것을 완벽하게 하려다가 스스로에게 과도한 압박을 주기도 해요. 쉬는 것을 게으름이라고 생각하거나, 성과가 바로 나오지 않으면 불안해하기도 하죠.",
                letter: "어떤 환경에서도 아름답게 피어나는 산호초처럼, 당신은 희망과 생명력의 상징이에요. 🌺<br><br>당신의 <strong>끊임없는 성장</strong>과 다른 사람들을 응원하는 마음이 세상을 더 밝게 만들어주고 있어요. 당신의 속도로 천천히 자라가세요. ✨"
            },
            "pearl-wise": {
                title: "지혜로운 진주",
                subtitle: "깊은 사유와 고요한 힘을 가진 영혼",
                light: "당신은 조용하지만 깊은 지혜를 가진 사람입니다. 말보다는 행동으로, 화려함보다는 진정성으로 사람들에게 감동을 주어요. 당신의 침착함과 통찰력은 많은 사람들에게 신뢰받는 이유입니다.",
                shadow: "혼자만의 시간이 너무 많아서 외로움을 느낄 때가 있어요. 자신의 생각이 너무 복잡하다고 여겨서 다른 사람들과 소통하는 것을 어려워하기도 하죠.",
                letter: "오랜 시간 깊은 곳에서 지혜를 쌓아온 진주처럼, 당신은 정말 소중한 존재예요. ✨<br><br>당신의 <strong>조용한 지혜</strong>가 시끄러운 세상에 꼭 필요한 목소리가 되고 있어요. 당신의 깊이를 자랑스러워하세요. 💙"
            },
            "current-brave": {
                title: "역동적인 해류",
                subtitle: "용기 있게 새로운 길을 개척하는 영혼",
                light: "당신은 변화를 두려워하지 않을 뿐만 아니라 적극적으로 새로운 기회를 만들어내는 사람입니다. 도전정신이 강하고 남들이 가지 않은 길도 용감하게 걸어갈 수 있어요.",
                shadow: "때로는 너무 빠르게 변화하려다가 주변 사람들이 따라오기 어려워할 때가 있어요. 혼자 앞서 나가다가 외로움을 느끼기도 하죠.",
                letter: "새로운 길을 개척하는 용감한 해류처럼, 당신은 세상에 변화의 바람을 일으키는 사람이에요. 🌊<br><br>당신의 <strong>용감한 도전정신</strong>이 많은 사람들에게 가능성을 보여주고 있어요. 계속 흘러가세요, 당신만의 길을 만들면서요. ✨"
            },
            "abyss-free": {
                title: "자유로운 심연",
                subtitle: "깊이 있으면서도 구속받지 않는 영혼",
                light: "당신은 깊이 있는 사고와 자유로운 정신을 동시에 가진 독특한 사람입니다. 진지하게 생각할 줄 알면서도 틀에 얽매이지 않는 유연함이 있어요. 이런 조합은 정말 드물고 소중합니다.",
                shadow: "깊이 있는 생각과 자유로운 성향 사이에서 갈등할 때가 있어요. 진지해야 할지 가볍게 넘어가야 할지 헷갈리기도 하고, 이런 자신이 일관성이 없다고 느낄 수도 있어요.",
                letter: "깊은 곳까지 자유롭게 탐험하는 당신은 정말 특별한 존재예요. 🔮<br><br>깊이와 자유로움, 이 둘을 모두 가진 것은 <strong>당신만의 독특한 매력</strong>이에요. 그 모순되어 보이는 조합이 실은 당신의 가장 큰 강점입니다. 💙"
            },
            "coral-gentle": {
                title: "온화한 산호초",
                subtitle: "부드럽게 성장하며 주변을 아름답게 하는 영혼",
                light: "당신은 꾸준하면서도 온화한 방식으로 성장하는 사람입니다. 경쟁보다는 협력을, 속도보다는 지속성을 중요하게 여기죠. 당신 주변에는 항상 따뜻하고 평화로운 분위기가 흘러요.",
                shadow: "때로는 너무 겸손해서 자신의 성취를 제대로 인정하지 않을 때가 있어요. 다른 사람을 배려하느라 자신의 필요를 뒤로 미루기도 하죠.",
                letter: "부드럽게 자라나며 주변을 아름답게 만드는 산조초처럼, 당신은 세상에 평화와 아름다움을 가져다주는 존재예요. 🌺<br><br>당신의 <strong>온화한 성장</strong>이 많은 생명들에게 안식처가 되고 있어요. 서두르지 말고 계속 그렇게 아름답게 피어나세요. ✨"
            },
            "pearl-free": {
                title: "자유로운 진주",
                subtitle: "고요함 속에서도 자유로운 영혼을 간직한 존재",
                light: "당신은 평온함을 사랑하면서도 어떤 것에도 얽매이지 않는 자유로운 정신을 가진 사람입니다. 조용하지만 결코 수동적이지 않고, 필요할 때는 과감하게 자신만의 길을 선택할 줄 알아요.",
                shadow: "평온함과 자유로움 사이에서 균형을 찾기 어려울 때가 있어요. 때로는 안정을 원하다가도 또 변화를 갈망하게 되어 혼란스러울 수 있어요.",
                letter: "고요한 바다 속을 자유롭게 유영하는 진주처럼, 당신은 독특하고 아름다운 존재예요. ✨<br><br>평온함과 자유로움을 동시에 추구하는 것은 <strong>당신만의 특별한 지혜</strong>예요. 그 균형을 찾아가는 여정을 즐기세요. 💙"
            },
            "current-wise": {
                title: "지혜로운 해류",
                subtitle: "변화 속에서도 깊은 통찰을 가진 영혼",
                light: "당신은 끊임없이 변화하면서도 그 속에서 의미와 패턴을 찾아내는 지혜로운 사람입니다. 경험을 통해 배우고 성장하는 능력이 뛰어나며, 변화를 단순히 받아들이는 것이 아니라 그것으로부터 깊은 깨달음을 얻어요.",
                shadow: "너무 깊이 생각하다 보니 변화의 속도가 느려질 때가 있어요. 모든 것을 분석하고 이해하려다가 기회를 놓치기도 하죠.",
                letter: "흘러가면서도 깊은 지혜를 간직한 해류처럼, 당신은 변화와 성찰의 완벽한 조화를 이루고 있어요. 🌊<br><br>당신의 <strong>흐르는 지혜</strong>가 변화하는 세상에 방향을 제시해주고 있어요. 계속 흘러가세요, 당신만의 깊이를 가지고요. 🔮"
            },
            "abyss-gentle": {
                title: "온화한 심연",
                subtitle: "깊은 곳에서도 따뜻함을 잃지 않는 영혼",
                light: "당신은 깊이 있는 사고를 하면서도 다른 사람들에 대한 따뜻한 마음을 잃지 않는 사람입니다. 복잡한 감정과 상황을 이해하는 능력이 뛰어나면서도, 그것을 부드럽고 따뜻하게 표현할 줄 알아요.",
                shadow: "깊은 감정을 너무 많이 흡수해서 때로는 감정적으로 지칠 때가 있어요. 다른 사람들의 아픔을 자신의 것처럼 느끼다 보니 힘들 수도 있어요.",
                letter: "가장 깊은 곳에서도 온화함을 잃지 않는 당신은 정말 특별한 사람이에요. 🔮<br><br>당신의 <strong>깊고 따뜻한 마음</strong>이 이 세상을 더 이해할 만한 곳으로 만들어주고 있어요. 그 깊이와 온화함을 모두 소중히 여기세요. 💙"
            }
        };

        // 로딩 메시지
        const loadingMessages = [
            "바다 깊은 곳에서 소중한 것을 발견했습니다",
            "당신만의 특별한 빛을 찾고 있어요",
            "마음의 보물이 모습을 드러내고 있습니다",
            "깊은 곳에서 온 메시지를 준비하고 있어요"
        ];

        // 배경 효과 생성
        function createBackgroundEffects() {
            function createWaterDrop() {
                const drop = document.createElement('div');
                drop.className = 'water-drop';
                drop.style.left = Math.random() * 100 + 'vw';
                drop.style.animationDuration = (Math.random() * 3 + 4) + 's';
                drop.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(drop);
                
                setTimeout(() => {
                    if (drop.parentNode) drop.remove();
                }, 7000);
            }

            function createShootingStar() {
                const star = document.createElement('div');
                star.className = 'shooting-star';
                star.style.left = Math.random() * 50 + 'vw';
                star.style.top = Math.random() * 50 + 'vh';
                star.style.animationDuration = (Math.random() * 2 + 3) + 's';
                document.body.appendChild(star);
                
                setTimeout(() => {
                    if (star.parentNode) star.remove();
                }, 5000);
            }

            setInterval(createWaterDrop, 2000);
            setInterval(createShootingStar, 8000);
            
            for(let i = 0; i < 3; i++) {
                setTimeout(createWaterDrop, i * 800);
            }
        }

        // 핵심 함수들 (완전히 새로 작성)
        function startJourney() {
            console.log('여행 시작');
            gameState.isTransitioning = false; // 강제 초기화
            showStory();
        }

        function showStory() {
            console.log('스토리 표시, 현재 스토리:', gameState.currentStory);
            
            if (gameState.currentStory < stories.length) {
                const story = stories[gameState.currentStory];
                document.getElementById('storyTitle').textContent = story.title;
                document.getElementById('storyText').innerHTML = story.text;
                
                showScreen('storyScreen');
                gameState.currentStory++;
            } else {
                showQuestion();
            }
        }

        function continueJourney() {
            console.log('여행 계속');
            gameState.isTransitioning = false; // 강제 초기화
            
            if (gameState.currentDepth < questions.length) {
                showQuestion();
            } else {
                showStory();
            }
        }

        function showQuestion() {
            console.log('질문 표시, 현재 깊이:', gameState.currentDepth);
            
            if (gameState.currentDepth >= questions.length) {
                showLoading();
                return;
            }

            const question = questions[gameState.currentDepth];
            
            // 진행도 업데이트
            const progress = ((gameState.currentDepth + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('depthIndicator').textContent = `수심 ${question.depth}m`;
            
            // 질문 표시
            document.getElementById('questionText').textContent = question.text;
            
            // 선택지 생성 (완전히 새로 작성)
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option.text;
                button.setAttribute('data-type', option.type);
                button.setAttribute('data-index', index);
                
                // 직접 이벤트 리스너 추가 (onclick 대신)
                button.addEventListener('click', function() {
                    handleOptionClick(option.type, index);
                });
                
                optionsContainer.appendChild(button);
            });
            
            showScreen('questionScreen');
            gameState.isTransitioning = false; // 질문 표시 후 상태 초기화
        }

        // 옵션 클릭 핸들러 (완전히 새로 작성)
        function handleOptionClick(type, index) {
            console.log('옵션 클릭됨:', type, index);
            
            // 중복 클릭 방지
            if (gameState.isTransitioning) {
                console.log('이미 처리 중...');
                return;
            }
            
            gameState.isTransitioning = true;

            // 모든 버튼 비활성화
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, i) => {
                btn.disabled = true;
                btn.style.pointerEvents = 'none';
                if (i !== index) {
                    btn.style.opacity = '0.3';
                } else {
                    btn.classList.add('selected');
                }
            });
            
            // 점수 추가 (안전하게)
            if (gameState.scores.hasOwnProperty(type)) {
                gameState.scores[type]++;
                console.log('점수 추가됨:', type, gameState.scores[type]);
            }
            gameState.responses.push(type);
            
            // 다음 단계로 이동
            setTimeout(() => {
                gameState.currentDepth++;
                console.log('다음 단계로 이동, 새로운 깊이:', gameState.currentDepth);
                
                if (gameState.currentDepth < questions.length) {
                    // 3문제마다 스토리 (스토리가 남아있을 때만)
                    if (gameState.currentDepth % 3 === 0 && gameState.currentStory < stories.length) {
                        console.log('중간 스토리 표시');
                        showStory();
                    } else {
                        console.log('다음 질문 표시');
                        showQuestion();
                    }
                } else {
                    console.log('모든 질문 완료, 로딩 표시');
                    showLoading();
                }
            }, 800); // 딜레이 줄임
        }

        function showLoading() {
            const messages = loadingMessages;
            let messageIndex = 0;
            
            const messageElement = document.getElementById('loadingMessage');
            messageElement.textContent = messages[messageIndex];
            
            showScreen('loadingScreen');
            
            const interval = setInterval(() => {
                messageIndex = (messageIndex + 1) % messages.length;
                messageElement.textContent = messages[messageIndex];
            }, 2000);
            
            setTimeout(() => {
                clearInterval(interval);
                showResult();
            }, 6000);
        }

        function showResult() {
            // 결과 계산 - 더 정교한 알고리즘
            const resultKey = calculateResultType();
            const result = results[resultKey];
            
            if (!result) {
                // 기본 결과
                const maxScore = Math.max(...Object.values(gameState.scores));
                const mainType = Object.keys(gameState.scores).find(key => gameState.scores[key] === maxScore);
                const fallbackResults = {
                    pearl: results["pearl-gentle"],
                    current: results["current-free"], 
                    abyss: results["abyss-wise"],
                    coral: results["coral-brave"]
                };
                result = fallbackResults[mainType] || results["pearl-gentle"];
            }
            
            // 결과 표시
            document.getElementById('resultTitle').textContent = result.title;
            document.getElementById('resultSubtitle').textContent = result.subtitle;
            document.getElementById('lightSide').textContent = result.light;
            document.getElementById('shadowSide').textContent = result.shadow;
            document.getElementById('letterContent').innerHTML = result.letter;
            
            showScreen('resultScreen');
            
            // 결과 저장
            const resultData = {
                type: resultKey,
                result: result,
                responses: gameState.responses,
                scores: gameState.scores,
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('mindDiveResult', JSON.stringify(resultData));
            } catch (e) {
                console.log('저장 실패:', e);
            }
        }

        function calculateResultType() {
            const scores = gameState.scores;
            
            // 주요 타입 결정
            const mainTypes = ['pearl', 'current', 'abyss', 'coral'];
            const subTypes = ['gentle', 'brave', 'wise', 'free'];
            
            const mainMax = Math.max(...mainTypes.map(type => scores[type]));
            const subMax = Math.max(...subTypes.map(type => scores[type]));
            
            const mainType = mainTypes.find(type => scores[type] === mainMax);
            const subType = subTypes.find(type => scores[type] === subMax);
            
            // 조합 키 생성
            const resultKey = `${mainType}-${subType}`;
            
            // 존재하는 조합인지 확인
            if (results[resultKey]) {
                return resultKey;
            }
            
            // 대체 로직
            const alternatives = [
                `${subType}-${mainType}`,
                mainType + '-gentle',
                'pearl-gentle'
            ];
            
            for (const alt of alternatives) {
                if (results[alt]) {
                    return alt;
                }
            }
            
            return 'pearl-gentle';
        }

        function showScreen(screenId) {
            console.log('화면 전환 시도:', screenId);
            
            try {
                // 모든 화면 숨기기
                const allScreens = document.querySelectorAll('.screen');
                allScreens.forEach(screen => {
                    screen.classList.add('hidden');
                });
                
                // 대상 화면 표시
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    console.log('화면 전환 성공:', screenId);
                    window.scrollTo(0, 0);
                } else {
                    console.error('화면을 찾을 수 없음:', screenId);
                }
            } catch (e) {
                console.error('화면 전환 중 오류:', e);
            }
        }

        function shareKakao() {
            const resultData = getStoredResult();
            if (resultData) {
                const text = `MIND DIVE에서 발견한 나의 모습: ${resultData.result.title}\n\n${resultData.result.subtitle}\n\n당신도 마음의 심해로 여행을 떠나보세요! ✨`;
                
                // 카카오톡 공유 (실제 구현시 카카오 SDK 필요)
                if (typeof Kakao !== 'undefined' && Kakao.Link) {
                    Kakao.Link.sendDefault({
                        objectType: 'text',
                        text: text,
                        link: {
                            mobileWebUrl: window.location.href,
                            webUrl: window.location.href,
                        },
                    });
                } else {
                    // 백업: 클립보드 복사
                    copyToClipboard(text + '\n' + window.location.href);
                    alert('카카오톡 링크가 클립보드에 복사되었습니다!');
                }
            }
        }

        function shareResult() {
            const resultData = getStoredResult();
            if (resultData) {
                const text = `MIND DIVE에서 발견한 나의 모습: ${resultData.result.title}\n\n${resultData.result.subtitle}\n\n당신도 마음의 심해로 여행을 떠나보세요! ✨`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'MIND DIVE 결과',
                        text: text,
                        url: window.location.href
                    }).catch(e => {
                        console.log('공유 실패:', e);
                        copyToClipboard(text + '\n' + window.location.href);
                        alert('결과가 클립보드에 복사되었습니다!');
                    });
                } else {
                    copyToClipboard(text + '\n' + window.location.href);
                    alert('결과가 클립보드에 복사되었습니다!');
                }
            }
        }

        function copyLink() {
            copyToClipboard(window.location.href);
            alert('링크가 클립보드에 복사되었습니다!');
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).catch(e => {
                    console.log('클립보드 복사 실패:', e);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('복사 실패:', err);
            }
            
            document.body.removeChild(textArea);
        }

        function getStoredResult() {
            try {
                const saved = localStorage.getItem('mindDiveResult');
                return saved ? JSON.parse(saved) : null;
            } catch (e) {
                console.log('저장된 결과 로드 실패:', e);
                return null;
            }
        }

        function restartDive() {
            // 상태 완전 초기화
            gameState = {
                currentDepth: 0,
                currentStory: 0,
                responses: [],
                isTransitioning: false,
                scores: {
                    pearl: 0,
                    current: 0,
                    abyss: 0,
                    coral: 0,
                    gentle: 0,
                    brave: 0,
                    wise: 0,
                    free: 0
                }
            };
            
            showScreen('welcomeScreen');
        }

        // 초기화
        window.addEventListener('load', () => {
            console.log('페이지 로드 완료');
            
            createBackgroundEffects();
            initAudio();
            
            // 디버깅: 초기 상태 확인
            console.log('초기 게임 상태:', gameState);
            
            // 저장된 결과 확인
            if (window.location.hash === '#result') {
                const saved = getStoredResult();
                if (saved) {
                    document.getElementById('resultTitle').textContent = saved.result.title;
                    document.getElementById('resultSubtitle').textContent = saved.result.subtitle;
                    document.getElementById('lightSide').textContent = saved.result.light;
                    document.getElementById('shadowSide').textContent = saved.result.shadow;
                    document.getElementById('letterContent').innerHTML = saved.result.letter;
                    showScreen('resultScreen');
                }
            }
        });

        // 에러 핸들링 강화
        window.addEventListener('error', (e) => {
            console.error('전역 오류 발생:', e);
            gameState.isTransitioning = false;
            
            // 사용자에게 알림 (선택사항)
            // alert('일시적인 오류가 발생했습니다. 페이지를 새로고침해주세요.');
        });

        // 디버깅 함수 (개발용)
        window.debugMindDive = () => {
            console.log('현재 게임 상태:', gameState);
            console.log('현재 질문:', questions[gameState.currentDepth]);
            console.log('현재 스토리:', stories[gameState.currentStory]);
        };

        // 페이지 이탈 방지 (선택사항)
        window.addEventListener('beforeunload', (e) => {
            if (gameState.currentDepth > 0 && gameState.currentDepth < questions.length) {
                e.preventDefault();
                e.returnValue = '진행 중인 테스트가 있습니다. 정말 나가시겠습니까?';
            }
        });
    </script>
</body>
</html>
